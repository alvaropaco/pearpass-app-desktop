app-id: com.pears.pass
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: pearpass

finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --filesystem=home
  - --filesystem=xdg-config/pear:create
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.secrets
  - --env=LD_LIBRARY_PATH=/app/lib

modules:
  - name: pearpass
    buildsystem: simple
    build-commands:
      # ── Extract AppImage ──────────────────────────────────────────────
      - chmod +x PearPass.AppImage
      - ./PearPass.AppImage --appimage-extract

      # ── Install binary ────────────────────────────────────────────────
      - install -Dm755 squashfs-root/usr/bin/pear-pass /app/bin/pear-pass

      # ── Install native libraries ──────────────────────────────────────
      - mkdir -p /app/lib
      - cp -a squashfs-root/usr/lib/*.so* /app/lib/

      # ── Install app bundle ────────────────────────────────────────────
      - mkdir -p /app/share/pear-pass
      - cp -r squashfs-root/usr/share/pear-pass/* /app/share/pear-pass/

      # ── Install app key (generated by build script) ──────────────────
      - install -Dm644 pear-app-key /app/share/pear-pass/pear-app-key

      # ── Install wrapper script ────────────────────────────────────────
      - |
        cat > /app/bin/pearpass <<'WRAPPER'
        #!/bin/bash
        export LD_LIBRARY_PATH="/app/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"

        # Read Pear app key
        PEAR_APP_KEY="$(cat /app/share/pear-pass/pear-app-key 2>/dev/null)"

        # Detect architecture for pear-runtime path
        case "$(uname -m)" in
          x86_64)        PEAR_ARCH="linux-x64" ;;
          aarch64|arm64) PEAR_ARCH="linux-arm64" ;;
          *)             PEAR_ARCH="linux-$(uname -m)" ;;
        esac

        PEAR_RUNTIME="$HOME/.config/pear/current/by-arch/$PEAR_ARCH/bin/pear-runtime"

        if [[ -x "$PEAR_RUNTIME" && -n "$PEAR_APP_KEY" ]]; then
          # Pear platform installed – exec runtime directly so it becomes
          # the main process and flatpak keeps the sandbox alive.
          # --no-sandbox: Chrome sandbox conflicts with flatpak sandbox
          CHROME_FLAGS="--no-sandbox --ozone-platform-hint=auto"
          if [[ -n "${WAYLAND_DISPLAY:-}" ]]; then
            CHROME_FLAGS="$CHROME_FLAGS --enable-features=WaylandWindowDecorations"
          fi
          exec "$PEAR_RUNTIME" run "pear://$PEAR_APP_KEY" $CHROME_FLAGS "$@"
        else
          # Platform not yet installed – fall back to the bootstrapper
          exec /app/bin/pear-pass "$@"
        fi
        WRAPPER
      - chmod +x /app/bin/pearpass

      # ── Desktop integration ───────────────────────────────────────────
      - install -Dm644 com.pears.pass.desktop /app/share/applications/com.pears.pass.desktop
      - install -Dm644 com.pears.pass.metainfo.xml /app/share/metainfo/com.pears.pass.metainfo.xml

      # ── Install icon (pre-resized to 512x512 by build script) ────────
      - install -Dm644 icon-512.png /app/share/icons/hicolor/512x512/apps/com.pears.pass.png

    sources:
      - type: file
        path: appimage/PearPass.AppImage
      - type: file
        path: com.pears.pass.desktop
      - type: file
        path: com.pears.pass.metainfo.xml
      - type: file
        path: icon-512.png
      - type: file
        path: pear-app-key

