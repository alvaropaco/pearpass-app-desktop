app-id: com.pears.pass
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: pearpass

finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.secrets
  # GVFS mount tracker is accessed via org.gtk.vfs.MountTracker on the session bus.
  # Some setups error with ServiceUnknown/activation issues; allowing the name avoids
  # policy-related failures and improves file chooser / mounts integration.
  - --talk-name=org.gtk.vfs.*
  - --env=LD_LIBRARY_PATH=/app/lib

modules:
  - name: pearpass
    buildsystem: simple
    build-commands:
      # ── Extract AppImage ──────────────────────────────────────────────
      - chmod +x PearPass.AppImage
      - ./PearPass.AppImage --appimage-extract

      # ── Install binary ────────────────────────────────────────────────
      - install -Dm755 squashfs-root/usr/bin/pear-pass /app/bin/pear-pass

      # ── Install native libraries ──────────────────────────────────────
      - mkdir -p /app/lib
      - cp -a squashfs-root/usr/lib/*.so* /app/lib/

      # ── Install app bundle ────────────────────────────────────────────
      - mkdir -p /app/share/pear-pass
      - cp -r squashfs-root/usr/share/pear-pass/* /app/share/pear-pass/

      # ── Install wrapper script ────────────────────────────────────────
      - |
        cat > /app/bin/pearpass <<'WRAPPER'
        #!/bin/bash
        export LD_LIBRARY_PATH="/app/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"

        # Workarounds for virtual GPUs (notably QEMU):
        # - Mesa may fail to pick a physical device (e.g. "ZINK: failed to choose pdev")
        # - GTK4's GL/Vulkan renderers can be unstable on llvmpipe/VMs ("no UI"/hangs)
        # - DMABUF rendering (WebKitGTK) can be problematic on software/virtual GPUs
        is_qemu=0
        for f in \
          /sys/class/dmi/id/sys_vendor \
          /sys/class/dmi/id/product_name \
          /sys/devices/virtual/dmi/id/sys_vendor \
          /sys/devices/virtual/dmi/id/product_name; do
          if [[ -r "$f" ]] && grep -qi 'qemu' "$f"; then
            is_qemu=1
            break
          fi
        done
        
        if [[ "$is_qemu" == "1" ]]; then
          # Force software rendering ONLY if the user hasn't already chosen.
          if [[ -z "${LIBGL_ALWAYS_SOFTWARE:-}" ]]; then
            export LIBGL_ALWAYS_SOFTWARE=1
          fi
          # Prefer a safer GTK renderer on VMs unless explicitly overridden.
          export GSK_RENDERER="${GSK_RENDERER:-cairo}"
          # Disable DMABUF for WebKit-based UI unless explicitly overridden.
          export WEBKIT_DISABLE_DMABUF_RENDERER="${WEBKIT_DISABLE_DMABUF_RENDERER:-1}"
        fi

        # Run the bundled PearPass binary against the bundled app bundle.
        # Do not access the host's home/config; Flatpak should use its own
        # per-app data under ~/.var/app/com.pears.pass.
        # Force argv[0] so GTK/Wayland derives a stable app_id that matches the
        # Flatpak application ID (helps GNOME associate/show the window).
        exec -a com.pears.pass /app/bin/pear-pass /app/share/pear-pass/app.bundle "$@"
        WRAPPER
      - chmod +x /app/bin/pearpass

      # ── Desktop integration ───────────────────────────────────────────
      - install -Dm644 com.pears.pass.desktop /app/share/applications/com.pears.pass.desktop
      - install -Dm644 com.pears.pass.metainfo.xml /app/share/metainfo/com.pears.pass.metainfo.xml

      # ── Install icon (pre-resized to 512x512 by build script) ────────
      - install -Dm644 icon-512.png /app/share/icons/hicolor/512x512/apps/com.pears.pass.png

    sources:
      - type: file
        path: appimage/PearPass.AppImage
      - type: file
        path: com.pears.pass.desktop
      - type: file
        path: com.pears.pass.metainfo.xml
      - type: file
        path: icon-512.png

